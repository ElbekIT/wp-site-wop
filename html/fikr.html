<!DOCTYPE html>
<html lang="uz">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Fikr bildirish - Elbek Online Shop</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
  <style>
    body {
      font-family: 'Arial', sans-serif;
      background-color: #e3f2fd;
      display: flex;
      justify-content: center;
      align-items: center;
      height: 100vh;
      margin: 0;
      animation: fadeIn 1.5s ease-in-out;
    }
    @keyframes fadeIn {
      from { opacity: 0; transform: scale(0.9); }
      to { opacity: 1; transform: scale(1); }
    }
    .feedback-container {
      background: linear-gradient(135deg, #ff6f61, #ff8e53);
      padding: 30px;
      border-radius: 15px;
      box-shadow: 0 10px 25px rgba(0, 0, 0, 0.3);
      width: 420px;
      text-align: center;
      color: white;
      animation: slideIn 1s ease-out;
    }
    @keyframes slideIn {
      from { transform: translateY(-50px); opacity: 0; }
      to { transform: translateY(0); opacity: 1; }
    }
    .feedback-container h2 {
      margin-bottom: 20px;
      font-size: 28px;
      font-weight: bold;
      text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.3);
    }
    .chat {
      width: 100%;
      height: 320px;
      overflow-y: auto;
      border: 1px solid rgba(255, 255, 255, 0.4);
      margin-bottom: 20px;
      padding: 10px;
      display: flex;
      flex-direction: column;
      gap: 12px;
      background-color: rgba(255, 255, 255, 0.15);
      border-radius: 10px;
    }
    .chat-message { display: flex; align-items: flex-start; }
    .chat-message img {
      width: 45px;
      height: 45px;
      border-radius: 50%;
      margin-right: 12px;
      border: 3px solid white;
    }
    .message-content {
      background-color: rgba(255, 255, 255, 0.25);
      padding: 12px;
      border-radius: 10px;
      max-width: 85%;
      color: white;
      box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
    }
    .message-content.sent {
      background-color: rgba(0, 150, 136, 0.9);
      align-self: flex-end;
    }
    .message-user {
      font-weight: bold;
      color: #ffeb3b;
      text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.3);
    }
    .input-field {
      width: 100%;
      padding: 14px;
      margin: 12px 0;
      border-radius: 10px;
      border: none;
      background-color: rgba(255, 255, 255, 0.25);
      color: white;
      font-size: 16px;
      box-shadow: inset 0 2px 4px rgba(0, 0, 0, 0.2);
    }
    .input-field::placeholder { color: rgba(255, 255, 255, 0.7); }
    .submit-btn {
      width: 100%;
      padding: 14px;
      background-color: #ff7043;
      color: white;
      border: none;
      border-radius: 10px;
      cursor: pointer;
      font-size: 18px;
      font-weight: bold;
      transition: background-color 0.3s ease, transform 0.2s ease;
      box-shadow: 0 4px 10px rgba(0, 0, 0, 0.2);
    }
    .submit-btn:hover {
      background-color: #f4511e;
      transform: translateY(-2px);
    }
    .delete-btn {
      background-color: transparent;
      color: #ff5252;
      border: none;
      font-size: 20px;
      cursor: pointer;
      margin-left: 10px;
      transition: color 0.3s ease;
    }
    .delete-btn:hover { color: #d32f2f; }
    #alert {
      display: none;
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      background-color: rgba(255, 87, 34, 0.95);
      color: white;
      padding: 25px;
      border-radius: 15px;
      font-size: 20px;
      text-align: center;
      box-shadow: 0 6px 15px rgba(0, 0, 0, 0.4);
    }
    .camera-icon {
      position: absolute;
      bottom: 5px;
      right: 5px;
      font-size: 22px;
      color: #ffeb3b;
      background-color: rgba(0, 0, 0, 0.7);
      border-radius: 50%;
      padding: 6px;
      cursor: pointer;
      transition: background-color 0.3s ease, transform 0.2s ease;
    }
    .camera-icon:hover {
      background-color: rgba(0, 0, 0, 0.9);
      transform: scale(1.1);
    }
    .profile-img-container {
      position: relative;
      width: 55px;
      height: 55px;
      border-radius: 50%;
      overflow: hidden;
      margin: 0 auto 12px;
      border: 3px solid white;
      box-shadow: 0 4px 8px rgba(0, 0, 0, 0.3);
    }
    .auth-form {
      display: flex;
      flex-direction: column;
      align-items: center;
      margin-bottom: 20px;
    }
    .auth-form input {
      width: 100%;
      padding: 10px;
      margin: 8px 0;
      border: 1px solid #ccc;
      border-radius: 5px;
      font-size: 16px;
      background-color: rgba(255, 255, 255, 0.2);
      color: white;
    }
    .auth-form button {
      width: 100%;
      padding: 12px;
      background-color: #4CAF50;
      color: white;
      border: none;
      border-radius: 5px;
      cursor: pointer;
      font-size: 18px;
      transition: background-color 0.3s ease;
    }
    .auth-form button:hover {
      background-color: #3e8e41;
    }
    #auth-message {
      color: yellow;
      margin-top: 10px;
    }

  </style>
</head>
<body>

  <!-- Ogohlantirish: Fikr yozish uchun login talab qilinadi -->
  <div id="alert">CHATGA FIKR YOZISH UCHUN AVVAL ISMINGIZNI KIRITING!</div>

  <div class="feedback-container" id="feedbackContainer">
    <h2>Fikr bildirish (Chat)</h2>
    <p id="welcomeMessage"></p>
    <div class="chat" id="chatBox"></div>

    <div class="profile-img-container" id="profileImageContainer">
      <img id="profileImage" src="https://via.placeholder.com/40" alt="Profile Image">
      <span class="camera-icon" onclick="changeProfileImage()"><i class="fas fa-camera"></i></span>
    </div>
    <textarea id="comment" class="input-field" placeholder="Fikr yoki taklif yozing..." rows="5" required disabled></textarea>
    <button id="submitFeedback" class="submit-btn" disabled>Yuborish</button>
  </div>

    <div id="auth-form-container" style="display:none;">
    <form id="auth-form" class="auth-form">
        <input type="text" id="username" placeholder="Ismingiz" required>
        <button type="button" onclick="signInAnonymously()">Kirish</button>
        <p id="auth-message"></p>
    </form>
</div>

  <input type="file" id="imageUpload" style="display: none;" onchange="uploadImage()" accept="image/*">

  <script type="module">
    // Import the functions you need from the SDKs you need
    import { initializeApp } from "firebase/app";
    import { getAnalytics } from "firebase/analytics";
    import { getDatabase, ref, push, onValue, remove } from "firebase/database";
    import { getAuth, signInAnonymously, onAuthStateChanged } from "firebase/auth";
    // TODO: Add SDKs for Firebase products that you want to use
    // https://firebase.google.com/docs/web/setup#available-libraries

    // Your web app's Firebase configuration
    // For Firebase JS SDK v7.20.0 and later, measurementId is optional
    const firebaseConfig = {
      apiKey: "AIzaSyB9WxjdMN0X5MOTsyRc8h35V7BJ6GXvfTU",
      authDomain: "esho-uz-chat.firebaseapp.com",
      databaseURL: "https://esho-uz-chat-default-rtdb.firebaseio.com",
      projectId: "esho-uz-chat",
      storageBucket: "esho-uz-chat.firebasestorage.app",
      messagingSenderId: "903758998725",
      appId: "1:903758998725:web:ef9386490c75c21435d4ac",
      measurementId: "G-NXC66EZPR2"
    };

    // Initialize Firebase
    const app = initializeApp(firebaseConfig);
    const analytics = getAnalytics(app);
    const database = getDatabase(app);
    const messagesRef = ref(database, 'messages');
    const auth = getAuth(app);

    const alertMessage = document.getElementById('alert');
    const feedbackContainer = document.getElementById('feedbackContainer');
    const submitButton = document.getElementById('submitFeedback');
    const commentField = document.getElementById('comment');
    const chatBox = document.getElementById('chatBox');
    const profileImage = document.getElementById('profileImage');
    const imageUpload = document.getElementById('imageUpload');
    const authFormContainer = document.getElementById('auth-form-container');
    const authForm = document.getElementById('auth-form');
    const authMessage = document.getElementById('auth-message');

    // ------------------  Autentifikatsiya funksiyalari ------------------

    const signInAnonymously = () => {
        const username = document.getElementById('username').value;
        if (!username) {
          authMessage.innerText = 'Iltimos, ismingizni kiriting.';
          return;
        }

        signInAnonymously(auth)
            .then(() => {
                // Foydalanuvchi muvaffaqiyatli tizimga kirdi
                authMessage.innerText = 'Tizimga kirdingiz!';
                localStorage.setItem('username', username);  // Ismni saqlash
                showChatInterface();
            })
            .catch((error) => {
                const errorCode = error.code;
                const errorMessage = error.message;
                authMessage.innerText = `Xatolik: ${errorMessage}`;
                console.error('Login error:', errorCode, errorMessage);
            });
    };

    // ------------------ UI Funksiyalari ------------------
    const showChatInterface = () => {
        authFormContainer.style.display = 'none';
        feedbackContainer.style.display = 'block';
        commentField.disabled = false;
        submitButton.disabled = false;
        document.getElementById('alert').style.display = 'none';
    };

    const showAuthForm = () => {
        authFormContainer.style.display = 'block';
        feedbackContainer.style.display = 'none';
        commentField.disabled = true;
        submitButton.disabled = true;
    };


    // ------------------  Firebase Auth kuzatuvi ------------------
    onAuthStateChanged(auth, (user) => {
      if (user) {
          // Foydalanuvchi tizimga kirgan
          showChatInterface();
          const username = localStorage.getItem('username'); // Ismni olish
          document.getElementById('welcomeMessage').innerText = `Salom, ${username}! Fikr bildiring.`;
          //  localStorage.setItem('username', user.uid); // anonim foydalanuvchilar uchun ham ishlatiladi
      } else {
          // Foydalanuvchi tizimga kirmagan
          showAuthForm();
          localStorage.removeItem('username'); // Agar foydalanuvchi tizimdan chiqsa, username ni o'chirish
          document.getElementById('welcomeMessage').innerText = ''; // Xush kelibsiz xabarini tozalash
      }
      displayMessages(); // Har doim xabarlarni yangilash
    });

    // ------------------  Qolgan kodlar (avvalgidek) ------------------

    // Kamera ikonkasini bosish orqali profil rasmni tanlash
    function changeProfileImage() {
      imageUpload.click();
    }

    // Foydalanuvchi yangi rasm yuklasa
    function uploadImage() {
      const file = imageUpload.files[0];
      const reader = new FileReader();
      reader.onloadend = function () {
        profileImage.src = reader.result;
        localStorage.setItem('userImage', reader.result); // Rasmni saqlash
      };
      if (file) {
        reader.readAsDataURL(file);
      }
    }

    // Fikrlarni ko'rsatish
    const displayMessages = () => {
      onValue(messagesRef, (snapshot) => {
        const data = snapshot.val();
        const messages = data ? Object.entries(data) : [];
        chatBox.innerHTML = '';
        messages.forEach(([key, msg]) => {
          const messageDiv = document.createElement('div');
          messageDiv.classList.add('chat-message');

          // Foydalanuvchi rasm va ismi
          const userImageElement = document.createElement('img');
          userImageElement.src = localStorage.getItem('userImage') || 'https://via.placeholder.com/40';
          const messageContentDiv = document.createElement('div');
          messageContentDiv.classList.add('message-content');

          // Fikr va foydalanuvchi ismi
          messageContentDiv.innerHTML = `<span class="message-user">${msg.username}:</span> ${msg.comment}`;

          // Agar foydalanuvchi o'z fikrini yozgan bo'lsa, fikri o'ng tomonda bo'ladi
          if (msg.username === localStorage.getItem('username')) {
            messageContentDiv.classList.add('sent');
            const deleteButton = document.createElement('button');
            deleteButton.classList.add('delete-btn');
            deleteButton.innerHTML = '<i class="fas fa-trash-alt"></i>';
            deleteButton.onclick = () => deleteMessage(key);
            messageContentDiv.appendChild(deleteButton);
          }

          messageDiv.appendChild(userImageElement);
          messageDiv.appendChild(messageContentDiv);
          chatBox.appendChild(messageDiv);
        });
      });
    };

    // Fikrni o'chirish
    const deleteMessage = (messageKey) => {
        remove(ref(database, `messages/${messageKey}`))
        .then(() => {
            console.log("Message o'chirildi");
        })
        .catch((error) => {
            console.error("O'chirishda xatolik:", error);
        });
    };

    // Fikr yuborish
    document.getElementById('submitFeedback').addEventListener('click', () => {
      const comment = document.getElementById('comment').value;
      if (comment) {
          const username = localStorage.getItem('username');  // Foydalanuvchi ismini olamiz
        // Firebase ga xabar yuborish
        push(messagesRef, {
          username: username,
          comment: comment,
          timestamp: Date.now()
        });

        document.getElementById('comment').value = '';

        fetch('https://api.telegram.org/bot7557876194:AAFx_XvTbaJzkBwfj7lKUt6Yauf2KvnooHc/sendMessage', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            chat_id: '7702025887',
            text: `Yangi fikr:\nFoydalanuvchi: ${username}\nFikr: ${comment}`
          })
        })
        .then(response => response.json())
        .then(data => {
          console.log(data);
        })
        .catch(error => {
          console.error('Telegramga yuborishda xatolik:', error);
        });
      }
    });

    // Fikrlarni dastlabki ko'rsatish
    // displayMessages();
  </script>

</body>
</html>